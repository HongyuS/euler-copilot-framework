# 智能诊断部署指南

## 准备工作

+ 提前安装 [openEuler Copilot System 命令行（智能 Shell）客户端](../../../使用指南/命令行客户端/命令行助手使用指南.md)

+ 被诊断机器不能安装crictl和isula，只能有docker一个容器管理工具

+ 在需要被诊断的机器上安装gala-gopher和gala-anteater

**gala-gopher**:
```bash
# x86_64
docker pull hub.oepkgs.net/a-ops/gala-gopher-profiling-x86_64:latest

# aarch64
docker pull hub.oepkgs.net/a-ops/gala-gopher-profiling-aarch64:latest
```
gala-gopher相关配置参考：https://gitee.com/openeuler/gala-gopher
**gala-anteater**源码拉取：
```bash
# 请指定分支为930eulercopilot
git clone https://gitee.com/GS-Stephen_Curry/gala-anteater.git
```
安装部署请参考https://gitee.com/openeuler/gala-anteater
其中重点关注config/gala-anteater.yaml中Kafka和Prometheus的ip和port
```yaml
Kafka:
  server: "10.137.16.161"
  port: "9092"
  model_topic: "gala_anteater_hybrid_model_930eulercopilot"
  meta_topic: "gala_gopher_metadata"
  group_id: "gala_anteater_kafka_930eulercopilot"
  # auth_type: plaintext/sasl_plaintext, please set "" for no auth
  auth_type: ""
  username: ""
  password: ""

Prometheus:
  server: "10.137.16.161"
  port: "9090"
  steps: "5"
```
+ 安装 gala-ops
每个中间件的大致介绍：
kafka ： 一个数据库中间件， 分布式数据分流作用， 可以配置为当前的管理节点。
prometheus：性能监控， 配置需要监控的生产节点 ip list。
安装脚本参考
```bash
download_kafka_tarball() {
    KAFKA_VERSION='kafka_2.13-2.8.2'
    echo_info "- Download $KAFKA_VERSION tarball"
    if [ ! -f ${DOWNLOAD_DIR}/${KAFKA_VERSION}.tgz ] ; then
        echo "   Executing \"wget https://mirrors.huaweicloud.com/apache/kafka/2.8.2/${KAFKA_VERSION}.tgz\""
        wget https://mirrors.huaweicloud.com/apache/kafka/2.8.2/${KAFKA_VERSION}.tgz -P ${DOWNLOAD_DIR} --no-check-certificate
    fi

    if ! ls ${DOWNLOAD_DIR} | grep -q java-1.8.0-openjdk ; then
        yum_download java-1.8.0-openjdk
        install_rpm createrepo
        createrepo ${DOWNLOAD_DIR}
    fi
}

download_prometheus() {
    echo_info "- Download prometheus2 rpm"
    if [ ! -f ${DOWNLOAD_DIR}/prometheus2*.${OS_ARCH}.rpm ] ; then
        echo "   Executing \"yumdownloader prometheus2\""
        yum_download prometheus2
    fi
}
```
+ 修改 `euler-copilot-rca` 中config/config.json，配置gala-gopher镜像的container_id以及ip，Kafka和Prometheus的ip和port（需鱼上述gala-anteater配置保持一致）

```yaml
"gopher_container_id": "82f781b17e5c",
    "remote_host": "116.63.144.61"
  },
  "kafka": {
    "server": "10.42.0.1",
    "port": "9092",
    "storage_topic": "usad_intermediate_results",
    "anteater_result_topic": "gala_anteater_hybrid_model_930eulercopilot",
    "rca_result_topic": "gala_cause_inference_test",
    "meta_topic": "gala_gopher_metadata"
  },
  "prometheus": {
    "server": "10.42.0.1",
    "port": "9090",
    "steps": 5
  },
```
